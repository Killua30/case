<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title"></title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .navbar a {
            text-decoration: none;
            color: #333333;
            margin: 0 15px;
            font-size: 16px;
            transition: color 0.3s;
        }

        .navbar a:hover {
            color: #3882fc;
        }

        .navbar a.active {
            color: #3882fc;
            border-bottom: 2px solid #3882fc;
            padding-bottom: 5px;
        }

        .navbar .login {
            background-color: #6ba2fa;
            color: #ffffff;
            padding: 10px 20px;
            border-radius: 20px;
            transition: background-color 0.3s;
        }

        .navbar .login:hover {
            background-color: #3882fc;
        }

        .container {
            display: flex;
            height: auto;
        }

        .content {
            display: flex;
            flex: 1;
        }

        .left-panel,
        .right-panel {
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .left-panel {
            margin-top: 20px;
            background-color: #6ba2fa;
            flex: 1;
            max-width: 40%;
            border-radius: 50px;
            margin-left: 20px;
            margin-bottom: 20px;
        }

        .left-panel h2,
        .left-panel p {
            background-color: #6ba2fa;
            color: #ffffff;
            text-align: start;
            width: 100%;
        }

        .left-panel .button {
            width: 50%;
            padding: 10px;
            border: 2px solid #ffffff;
            border-radius: 20px;
            background-color: #ffffff;
            text-decoration: none;
            color: #354a82;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }

        .left-panel .button:hover {
            background-color: #6ba2fa;
        }

        .table {
            text-align: left;
            border-collapse: separate;
            border-spacing: 5px;
            background: #bfd7ff;
            color: #354a82;
            border: 16px solid #bfd7ff;
            border-radius: 20px;
            width: 100%;
            margin-top: 20px;
        }

        th {
            font-size: 18px;
            padding: 10px;
        }

        td {
            background: #ffffff;
            padding: 10px;
        }

        .right-panel {
            flex: 1;
            background-color: #ffffff;
        }

        .right-panel .h1 {
        font-size: 20px;
        color: #354a82;
        text-align: center;
        width: 100%;
        margin-top: 20px;
        margin-bottom: 20px;
      }

        .right-panel #svg1 {
            width: 100%;
            flex-direction: row;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }

        .right-panel #svg2 {
            width: 100%;
            flex-direction: row;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }

        .right-panel .bar {
            transition: fill 0.3s;
        }

        .right-panel .bar:hover {
            opacity: 0.7;
        }

        .right-panel .line {
            fill: none;
            stroke-width: 2;
        }

        .contact-section {
            background-color: #f9f9f9;
            padding: 40px 20px;
            text-align: center;
        }

        .contact-section h2 {
            font-size: 28px;
            color: #333333;
            margin-bottom: 20px;
        }

        .contact-section p {
            font-size: 18px;
            color: #666666;
            margin-bottom: 20px;
        }

        .contact-section a {
            text-decoration: none;
            color: #6ba2fa;
            font-weight: bold;
        }

        .container2 {
            display: flex;
            height: auto;
            background-color: #ffffff;
            align-items: center;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 40px;
        }

        .container2 .h3 {
            display: flex;
            margin-left: 20%;
            margin-right: 20%;
            margin-top: 40px;
            margin-bottom: 20px;
            height: auto;
            color: #354a82;
            text-align: center;
            font-size: 20px;
        }

        .container2 .p2 {
            display: flex;
            margin-left: 20%;
            margin-right: 20%;
            height: auto;
            color: #354a82;
            text-align: justify;
            font-size: 16px;
            flex-direction: column;
            justify-content: center;
        }

        .button {
            width: 50%;
            padding: 10px;
            border: 2px solid #ffffff;
            border-radius: 20px;
            background-color: #6ba2fa;
            text-decoration: none;
            color: #354a82;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }

        .button:hover {
            background-color: #3882fc;
        }

        .comment-section {
            display: flex;
            flex-direction: column;
            justify-items: center;
            align-items: center;
            width: 70%;
        }

        .comment-box {
            display: flex;
            background-color: #ffffff;
            height: 150px;
            width: 70%;
            border-radius: 10px;
            margin-top: 10px;
            margin-bottom: 20px;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
            font-size: 16px;
            border: 1px solid #333333;
            color: #7d7d7d;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="logo" style="font-weight: bold;">EvalExpert</div>
        <div class="nav-links">
            <a href="/">Главная</a>
            <a href="/tests">Тесты</a>
            <a href="/reviews">Отзывы</a>
            <a id="profile2" href="">Профиль</a>
            <script>
                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                }
                const profileLink2 = document.getElementById("profile2");
                const mail2 = getCookie("username");
                if (mail2) {
                    profileLink2.href = "/profile";
                }
                else {
                    profileLink2.href = "/login";
                }
            </script>
            <a class="active" href="/hr">HR</a>
            <a href="/materials">Полезные материалы</a>
        </div>
        <a id="profile" class="login" href="" style="color : #ffffff;">
        </a>
        <script>
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }
            const mail_c = getCookie("username");
            const mail = decodeURIComponent(getCookie("username"));
            const profileLink = document.getElementById("profile");
            if (mail_c) {
                profileLink.textContent = mail;
                profileLink.href = "/profile";
            }
            else {
                profileLink.textContent = "Войти";
                profileLink.href = "/login";
            }
        </script>
    </div>
    <div class="container">
        <div class="left-panel">
            <div class="employee-info" id="employee-info"></div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Тест</th>
                        <th>Дата</th>
                        <th>Результат</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div class="right-panel">
            <div class="h1">Результаты последних тестов</div>
        <canvas width="700" height="400" id="barChart"></canvas>
        <div class="h1" style="margin-top: 20px">
          Изменение результатов по времени
        </div>
        <canvas width="700" height="400" id="lineChart"></canvas>
        </div>
    </div>
    <div class="container2">
        <h class="h3">Коментарии о сотруднике:</h>
        <table class="table" style="width:70%;">
            <thead>
                <tr>
                    <th>ID HR</th>
                    <th>Дата</th>
                    <th>Комментарий</th>
                </tr>
            </thead>
            <tbody id="comment-body"></tbody>
        </table>
        <h class="h3">Добавление комментария о сотруднике</h>
        <div class="comment-section">
            <textarea class="comment-box" placeholder="Введите ваш комментарий здесь..." name="comment"
                required></textarea>
            <button class="button" id="submit-button">Добавить комментарий</button>
        </div>
    </div>
    <div class="contact-section">
        <h2>Свяжитесь с нами</h2>
        <p>Если у вас есть вопросы или предложения, не стесняйтесь обращаться к нам!</p>
        <p>Email: <a href="mailto:info@evalexpert.com">info@evalexpert.com</a></p>
        <p>Телефон: <a href="tel:+1234567890">+1 (234) 567-890</a></p>
    </div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const empidurl = window.location.pathname.split('/').pop();
        async function main() {
            async function get_employee_info(id) {
                const response = await fetch(`http://localhost:3001/api/emp-id/${id}`);
                const data = await response.text();
                const info = await JSON.parse(data);
                const employeeCard = document.createElement('div');
                employeeCard.className = 'employee-info';
                info.forEach(element => {
                    document.getElementById('title').textContent = `${element.empsurname} ${element.empname} ${element.emppatronymic}`;
                    employeeCard.innerHTML = `
                        <h2>${element.empsurname} ${element.empname} ${element.emppatronymic}</h2>
                        <p>Должность: ${element.empposition}</p>
                        <p>ID: ${element.empid}</p>
                        <p>Email: ${element.empmail}</p>
                    `;
                    document.getElementById('employee-info').appendChild(employeeCard);
                });
            };
            let typetestcompall = new Array();
            let resall = new Array();
            let dateall = new Array();
            const options2 = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            let alldata = null;
            async function all_results(id) {
                const response = await fetch(`http://localhost:3001/api/all-results/${id}`);
                const data = await response.text();
                const obj = JSON.parse(data);
                alldata = obj;
                const resultsBody = document.getElementById('table-body');
                obj.forEach(item => {
                    const row = resultsBody.insertRow();
                    const formattedDate = new Date(item.testdate).toLocaleString('ru-RU', options2);
                    dateall.push(formattedDate);
                    typetestcompall.push(item.typetestname);
                    resall.push(item.testresult);
                    Object.entries(item).forEach(([key, value]) => {
                        const cell = row.insertCell();
                        if (key === 'testdate') {
                            cell.textContent = formattedDate;
                        } else {
                            cell.textContent = value;
                        }
                    });
                });
            };
            let lastdata = null;
            async function last_results(id) {
                const response2 = await fetch(`http://localhost:3001/api/last-results/${id}`);
                const data = await response2.text();
                const last_results = JSON.parse(data);
                lastdata = last_results;
            };
            await all_results(empidurl);
            await get_employee_info(empidurl);
            await last_results(empidurl);
            //диаграмма
        
        const data = lastdata;
        const labels = data.map((d) => d.typetestname.split(" ").join("\n"));
        const testResults = data.map((d) => +d.testresult);
        const backgroundColors = data.map((d) =>
          d.softtrue ? "rgba(107, 162, 250, 0.6)" : "rgba(255, 107, 107, 0.6)"
        );

        const ctxBar = document.getElementById("barChart").getContext("2d");
        const barChart = new Chart(ctxBar, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Результат теста",
                data: testResults,
                backgroundColor: backgroundColors,
              },
            ],
          },
          options: {
            scales: {
              x: {
                ticks: {
                  autoSkip: false,
                  maxRotation: 0,
                  minRotation: 0,
                  font: {
                    size: 9,
                    lineHeight: 1.5,
                  },
                },
              },
              y: {
                beginAtZero: true,
                max: 100,
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (tooltipItem) {
                    return "Результат: " + tooltipItem.raw;
                  },
                },
              },
            },
          },
        });

        // график
        const dataAll = alldata.map((d) => ({
          testdate: new Date(d.testdate),
          testresult: +d.testresult,
          typetestname: d.typetestname,
        }));

        const groupedData = d3.group(dataAll, (d) => d.typetestname);
        const colorScale = d3.scaleOrdinal(d3.schemeSet3);
        const datasets = Array.from(groupedData).map(([key, values], index) => {
          return {
            label: key,
            data: values.map((d) => ({ x: d.testdate, y: d.testresult })),
            borderColor: colorScale(key),
            backgroundColor: colorScale(key),
            fill: false,
            tension: 0.1,
          };
        });

        const monthNames = [
          "Янв",
          "Февр",
          "Март",
          "Апр",
          "Май",
          "Июнь",
          "Июль",
          "Авг",
          "Сент",
          "Окт",
          "Нояб",
          "Дек",
        ];
        const ctxLine = document.getElementById("lineChart").getContext("2d");
        const lineChart = new Chart(ctxLine, {
          type: "line",
          data: {
            datasets: datasets,
          },
          options: {
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "month",
                  tooltipFormat: "MMM d, yyyy",
                  displayFormats: {
                    month: "MMM yyyy",
                  },
                },
                ticks: {
                  autoSkip: false,
                  maxRotation: 45,
                  minRotation: 45,
                  font: {
                    size: 9,
                    lineHeight: 1.5,
                  },
                  callback: function (value) {
                    const date = new Date(value);
                    return (
                      monthNames[date.getMonth()] + " " + date.getFullYear()
                    );
                  },
                },
              },
              y: {
                beginAtZero: true,
                max: 100,
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (tooltipItem) {
                    return "Результат: " + tooltipItem.raw.y;
                  },
                },
              },
            },
          },
        });
      }
      main();
    </script>
    <script>

        async function main999() {
            const options3 = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            };
            let alldate = new Array();
            let emps = new Array();
            let hrs = new Array();
            let allcom = new Array();
            async function get_comments(empid) {
                const response = await fetch(`http://localhost:3001/api/comments/${empid}`);
                const data = await response.text();
                const comments = JSON.parse(data);
                const resultsBody = document.getElementById("comment-body");
                comments.forEach((item) => {
                    const row = resultsBody.insertRow();
                    const formattedDate = new Date(item.date).toLocaleString("ru-RU", options3);
                    hrs.push(item.hrid);
                    alldate.push(formattedDate);
                    allcom.push(item.comment);
                    Object.entries(item).forEach(([key, value]) => {
                        const cell = row.insertCell();
                        if (key === "date") {
                            cell.textContent = formattedDate;
                        } else {
                            cell.textContent = value;
                        }
                    });
                });
            }
            await get_comments(empidurl);
            const submitButton = document.getElementById("submit-button");
            submitButton.addEventListener("click", async () => {
                const com = document.querySelector(
                    'textarea[name="comment"]'
                ).value;
                let jsonresult = {
                    empid: empidurl,
                    hrid: getCookie("empid"),
                    comment: com
                };
                try {
                    let response = await fetch(`http://localhost:3001/api/add-comment`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json;charset=utf-8",
                        },
                        body: JSON.stringify(jsonresult),
                    });

                    if (!response.ok) {
                        throw new Error("Ошибка при добавлении комментария");
                    }
                    alert(`Комментарий успешно добавлен!`);
                } catch (error) {
                    console.error("Ошибка:", error);
                    alert(
                        "Произошла ошибка при добавлении комментария. Пожалуйста, попробуйте еще раз."
                    );
                }
            });
        }
        main999();
    </script>
</body>

</html>